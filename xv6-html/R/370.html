<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<title>log</title>
<meta name='robots' content='noindex,nofollow' />
<meta name='generator' content='GLOBAL-6.5.1' />
<meta http-equiv='Content-Style-Type' content='text/css' />
<link rel='stylesheet' type='text/css' href='../style.css' />
</head>
<body>
<pre>
<span class='curline'><a href='../S/38.html#L47'>log</a>                47 log.c          struct log log;</span>
<span class='curline'><a href='../S/38.html#L59'>log</a>                59 log.c            initlock(&amp;log.lock, "log");</span>
<span class='curline'><a href='../S/38.html#L61'>log</a>                61 log.c            log.start = sb.logstart;</span>
<span class='curline'><a href='../S/38.html#L62'>log</a>                62 log.c            log.size = sb.nlog;</span>
<span class='curline'><a href='../S/38.html#L63'>log</a>                63 log.c            log.dev = dev;</span>
<span class='curline'><a href='../S/38.html#L73'>log</a>                73 log.c            for (tail = 0; tail &lt; log.lh.n; tail++) {</span>
<span class='curline'><a href='../S/38.html#L74'>log</a>                74 log.c              struct buf *lbuf = bread(log.dev, log.start+tail+1); // read log block</span>
<span class='curline'><a href='../S/38.html#L75'>log</a>                75 log.c              struct buf *dbuf = bread(log.dev, log.lh.block[tail]); // read dst</span>
<span class='curline'><a href='../S/38.html#L87'>log</a>                87 log.c            struct buf *buf = bread(log.dev, log.start);</span>
<span class='curline'><a href='../S/38.html#L90'>log</a>                90 log.c            log.lh.n = lh-&gt;n;</span>
<span class='curline'><a href='../S/38.html#L91'>log</a>                91 log.c            for (i = 0; i &lt; log.lh.n; i++) {</span>
<span class='curline'><a href='../S/38.html#L92'>log</a>                92 log.c              log.lh.block[i] = lh-&gt;block[i];</span>
<span class='curline'><a href='../S/38.html#L103'>log</a>               103 log.c            struct buf *buf = bread(log.dev, log.start);</span>
<span class='curline'><a href='../S/38.html#L106'>log</a>               106 log.c            hb-&gt;n = log.lh.n;</span>
<span class='curline'><a href='../S/38.html#L107'>log</a>               107 log.c            for (i = 0; i &lt; log.lh.n; i++) {</span>
<span class='curline'><a href='../S/38.html#L108'>log</a>               108 log.c              hb-&gt;block[i] = log.lh.block[i];</span>
<span class='curline'><a href='../S/38.html#L119'>log</a>               119 log.c            log.lh.n = 0;</span>
<span class='curline'><a href='../S/38.html#L127'>log</a>               127 log.c            acquire(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L129'>log</a>               129 log.c              if(log.committing){</span>
<span class='curline'><a href='../S/38.html#L130'>log</a>               130 log.c                sleep(&amp;log, &amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L131'>log</a>               131 log.c              } else if(log.lh.n + (log.outstanding+1)*MAXOPBLOCKS &gt; LOGSIZE){</span>
<span class='curline'><a href='../S/38.html#L133'>log</a>               133 log.c                sleep(&amp;log, &amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L135'>log</a>               135 log.c                log.outstanding += 1;</span>
<span class='curline'><a href='../S/38.html#L136'>log</a>               136 log.c                release(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L149'>log</a>               149 log.c            acquire(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L150'>log</a>               150 log.c            log.outstanding -= 1;</span>
<span class='curline'><a href='../S/38.html#L151'>log</a>               151 log.c            if(log.committing)</span>
<span class='curline'><a href='../S/38.html#L153'>log</a>               153 log.c            if(log.outstanding == 0){</span>
<span class='curline'><a href='../S/38.html#L155'>log</a>               155 log.c              log.committing = 1;</span>
<span class='curline'><a href='../S/38.html#L158'>log</a>               158 log.c              wakeup(&amp;log);</span>
<span class='curline'><a href='../S/38.html#L160'>log</a>               160 log.c            release(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L166'>log</a>               166 log.c              acquire(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L167'>log</a>               167 log.c              log.committing = 0;</span>
<span class='curline'><a href='../S/38.html#L168'>log</a>               168 log.c              wakeup(&amp;log);</span>
<span class='curline'><a href='../S/38.html#L169'>log</a>               169 log.c              release(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L179'>log</a>               179 log.c            for (tail = 0; tail &lt; log.lh.n; tail++) {</span>
<span class='curline'><a href='../S/38.html#L180'>log</a>               180 log.c              struct buf *to = bread(log.dev, log.start+tail+1); // log block</span>
<span class='curline'><a href='../S/38.html#L181'>log</a>               181 log.c              struct buf *from = bread(log.dev, log.lh.block[tail]); // cache block</span>
<span class='curline'><a href='../S/38.html#L192'>log</a>               192 log.c            if (log.lh.n &gt; 0) {</span>
<span class='curline'><a href='../S/38.html#L196'>log</a>               196 log.c              log.lh.n = 0; </span>
<span class='curline'><a href='../S/38.html#L215'>log</a>               215 log.c            if (log.lh.n &gt;= LOGSIZE || log.lh.n &gt;= log.size - 1)</span>
<span class='curline'><a href='../S/38.html#L217'>log</a>               217 log.c            if (log.outstanding &lt; 1)</span>
<span class='curline'><a href='../S/38.html#L220'>log</a>               220 log.c            acquire(&amp;log.lock);</span>
<span class='curline'><a href='../S/38.html#L221'>log</a>               221 log.c            for (i = 0; i &lt; log.lh.n; i++) {</span>
<span class='curline'><a href='../S/38.html#L222'>log</a>               222 log.c              if (log.lh.block[i] == b-&gt;blockno)   // log absorbtion</span>
<span class='curline'><a href='../S/38.html#L225'>log</a>               225 log.c            log.lh.block[i] = b-&gt;blockno;</span>
<span class='curline'><a href='../S/38.html#L226'>log</a>               226 log.c            if (i == log.lh.n)</span>
<span class='curline'><a href='../S/38.html#L227'>log</a>               227 log.c              log.lh.n++;</span>
<span class='curline'><a href='../S/38.html#L229'>log</a>               229 log.c            release(&amp;log.lock);</span>
</pre>
</body>
</html>
